<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Jeu des Clics ‚Äì R√©flexes</title>
<style>
    #click-area{
        width:min(360px, 100%);
        margin-top:10px;
        border-radius:18px;
        padding:16px 18px;
        font-size:1.2em;
        border:1px solid rgba(12,32,63,0.18);
        background:rgba(255,255,255,0.95);
        cursor:pointer;
        user-select:none;
        touch-action:manipulation;
        -webkit-touch-callout:none;
        box-shadow:0 14px 30px rgba(12,32,63,0.14);
        transition:transform 160ms var(--exercise-ease, ease), box-shadow 160ms var(--exercise-ease, ease), border-color 160ms var(--exercise-ease, ease);
    }
    #click-area:hover{transform:translateY(-1px);box-shadow:0 18px 40px rgba(12,32,63,0.16);}
    #click-area:active{transform:translateY(0);}
    #click-area:focus-visible{outline:3px solid rgba(11,107,255,0.35);outline-offset:2px;}
    #click-area:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
    #click-area.ok{border-color:rgba(22,163,74,0.55);box-shadow:0 0 0 4px rgba(22,163,74,0.12), 0 14px 30px rgba(12,32,63,0.14);}
    #click-area.bad{border-color:rgba(239,68,68,0.55);box-shadow:0 0 0 4px rgba(239,68,68,0.12), 0 14px 30px rgba(12,32,63,0.14);}
    .hint{font-size:0.95em;color:rgba(15,27,44,0.7);line-height:1.35;margin:10px 0 0;}
    .kbd{display:inline-block;padding:2px 8px;border-radius:10px;border:1px solid rgba(12,32,63,0.14);background:#fff;color:#0b2a4a;font-weight:800;font-size:0.9em;box-shadow:0 10px 18px rgba(12,32,63,0.10);}
    .game-over-stats{margin-top:10px;color:rgba(15,27,44,0.72);font-weight:700;}
</style>
  <link rel="stylesheet" href="../../exercise-layout.css">
  <link rel="stylesheet" href="../shared/game-modern.css">
  <script defer src="../../exercise-layout.js"></script>
  <script defer src="../shared/game-modern.js"></script>
</head>
<body>

<div class="back-home" style="max-width:1100px;margin:10px auto 0;padding:0 20px;">
  <a class="back-home__link" href="../../index.html" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:#004c6d;font-weight:700;border:1px solid #cfdff0;padding:6px 14px;border-radius:999px;background:#fff;box-shadow:0 2px 4px rgba(0,0,0,0.08);">‚Üê Retour √† l‚Äôindex</a>
</div>
<script src="../shared/proactif-exercise.js"></script>
<div class="exercise-shell">
  <main class="exercise-card">


<div class="game-app" id="game-app">
    <div class="game-topbar">
        <div class="game-topbar__title">
            <span class="game-badge">üñ±Ô∏è Jeu des Clics</span>
        </div>
        <div class="game-actions">
            <label class="game-badge" style="gap:10px;">
                Difficult√©
                <select id="difficulty" class="gselect" aria-label="Difficult√©">
                    <option value="easy">Facile</option>
                    <option value="normal" selected>Normal</option>
                    <option value="hard">Difficile</option>
                </select>
            </label>
            <button id="sound-toggle" type="button" class="gbtn" aria-pressed="true">üîä Son</button>
        </div>
    </div>

    <h1 style="margin:0 0 12px;">Jeu des clics</h1>

    <div class="game-stats" aria-label="Statistiques">
        <div class="gstat"><div class="gstat__label">Score</div><div class="gstat__value" id="score">0</div></div>
        <div class="gstat"><div class="gstat__label">Meilleur</div><div class="gstat__value" id="best">0</div></div>
        <div class="gstat"><div class="gstat__label">Niveau</div><div class="gstat__value" id="level">1</div></div>
        <div class="gstat"><div class="gstat__label">R√©action</div><div class="gstat__value" id="reaction">‚Äî</div></div>
    </div>

    <div class="game-stage">
        <div id="start-screen" class="game-screen is-active">
            <p class="game-instruction">R√©agis vite : fais exactement l‚Äôaction demand√©e.</p>
            <p style="margin:0;color:rgba(15,27,44,0.75);font-weight:700;">‚úî Clic gauche ¬∑ ‚úî Clic droit ¬∑ ‚úî Double-clic</p>
            <p id="input-hint" class="hint"></p>
            <div class="game-center" style="margin-top:14px;">
                <button id="btn" type="button" class="gbtn gbtn--primary">Commencer</button>
            </div>
        </div>

        <div id="game-screen" class="game-screen">
            <div class="timer-bar" aria-hidden="true"><div class="timer-fill" id="timer-fill"></div></div>
            <div class="game-center">
                <div id="consigne" class="game-big" aria-live="polite"></div>
                <button id="click-area" type="button">Action</button>
                <p style="margin:0;color:rgba(15,27,44,0.68);font-weight:700;">Astuce : tu peux aussi utiliser le clavier.</p>
            </div>
        </div>

        <div id="game-over" class="game-screen">
            <h2 style="color:#ef4444;margin:0 0 10px;">Fin du jeu</h2>
            <p id="final-score" style="font-size:2em;color:#0b6bff;font-weight:950;margin:0;"></p>
            <p id="final-details" class="game-over-stats"></p>
            <div class="game-center" style="margin-top:10px;">
                <button id="restart" type="button" class="gbtn gbtn--primary">Rejouer</button>
                <button id="back" type="button" class="gbtn">Retour au menu</button>
            </div>
        </div>
    </div>
</div>

<script>
let score = 0;
let best = Number(localStorage.getItem("bestClickScore") || 0);
let ready = false;
let currentAction = null;
let roundDelayTimeout = null;
let timerRaf = null;
let roundDurationMs = 4000;

let level = 1;
let promptAt = 0;
let reactionLastMs = 0;
let reactionBestMs = Infinity;
let reactionSumMs = 0;
let reactionCount = 0;

let longPressTimeout = null;
let longPressFired = false;
let awaitingDoubleTap = false;
let lastTapAt = 0;
let resetDoubleTapTimeout = null;
const LONG_PRESS_MS = 520;
const DOUBLE_TAP_MS = 320;

const DIFF_KEY = "proactif_clicks_difficulty_v1";
const DIFFICULTIES = {
    easy:   { label: "Facile", baseMs: 5200, minMs: 2400, decayMs: 45, delayMin: 1200, delayMax: 2600 },
    normal: { label: "Normal", baseMs: 4200, minMs: 1900, decayMs: 60, delayMin: 900,  delayMax: 2300 },
    hard:   { label: "Difficile", baseMs: 3400, minMs: 1400, decayMs: 75, delayMin: 700, delayMax: 2000 }
};
let difficulty = "normal";

const consignes = ["clic gauche","clic droit","double-clic"];
const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");
const levelEl = document.getElementById("level");
const reactionEl = document.getElementById("reaction");
const btn = document.getElementById("btn");
const restartBtn = document.getElementById("restart");
const backBtn = document.getElementById("back");
const consigneEl = document.getElementById("consigne");
const timerFill = document.getElementById("timer-fill");
const clickArea = document.getElementById("click-area");
const hintEl = document.getElementById("input-hint");
const finalDetailsEl = document.getElementById("final-details");
const appEl = document.getElementById("game-app");
const difficultyEl = document.getElementById("difficulty");
const soundToggle = document.getElementById("sound-toggle");
const ui = window.ProactifGameUI || null;

bestEl.textContent = best;

btn.addEventListener("click", startGame);
restartBtn.addEventListener("click", startGame);
backBtn.addEventListener("click", () => { window.location.href = "../../index.html"; });

function showScreen(id){
    const screens = ["start-screen","game-screen","game-over"];
    screens.forEach(x => {
        const el = document.getElementById(x);
        if (!el) return;
        el.classList.toggle("is-active", x === id);
    });
}

function isTypingTarget(target){
    const tag = (target && target.tagName) ? String(target.tagName).toLowerCase() : "";
    return tag === "input" || tag === "textarea" || tag === "select" || (target && target.isContentEditable);
}

function isTouchDevice(){
    try {
        return (navigator.maxTouchPoints && navigator.maxTouchPoints > 0) || (window.matchMedia && window.matchMedia("(pointer: coarse)").matches);
    } catch (e) {
        return false;
    }
}

function vibrate(pattern){
    try { if (navigator.vibrate) navigator.vibrate(pattern); } catch (e) {}
}

function nowMs(){
    try { return (performance && typeof performance.now === "function") ? performance.now() : Date.now(); } catch (e) { return Date.now(); }
}

function uiToast(message, type){
    if (ui && appEl) ui.toast(appEl, message, type || "info");
}

function uiOk(){
    if (!ui || !appEl) return;
    ui.playTone("ok");
    ui.confettiBurst(appEl, clickArea);
}

function uiBad(){
    if (ui) ui.playTone("bad");
}

function clearFeedback(){
    clickArea.classList.remove("ok","bad");
}

function setDifficulty(next){
    if (!DIFFICULTIES[next]) next = "normal";
    difficulty = next;
    try { localStorage.setItem(DIFF_KEY, difficulty); } catch (e) {}
}

function refreshDifficulty(){
    const cfg = DIFFICULTIES[difficulty] || DIFFICULTIES.normal;
    roundDurationMs = Math.max(cfg.minMs, cfg.baseMs - score * cfg.decayMs);
}

function setReady(value){
    ready = value;
    try { clickArea.disabled = !value; } catch (e) {}
    if (!value) {
        awaitingDoubleTap = false;
        clearTimeout(resetDoubleTapTimeout);
        resetDoubleTapTimeout = null;
    }
}

function stopRoundTimers(){
    clearTimeout(roundDelayTimeout);
    roundDelayTimeout = null;
    if (timerRaf) cancelAnimationFrame(timerRaf);
    timerRaf = null;
    clearTimeout(longPressTimeout);
    longPressTimeout = null;
    clearTimeout(resetDoubleTapTimeout);
    resetDoubleTapTimeout = null;
}

function startGame(){
    stopRoundTimers();
    clearFeedback();
    score = 0;
    scoreEl.textContent = "0";
    level = 1;
    levelEl.textContent = "1";

    reactionLastMs = 0;
    reactionBestMs = Infinity;
    reactionSumMs = 0;
    reactionCount = 0;
    reactionEl.textContent = "‚Äî";

    refreshDifficulty();
    showScreen("game-screen");
    nextRound();
}

function nextRound(){
    stopRoundTimers();
    clearFeedback();
    setReady(false);
    consigneEl.textContent = "Pr√©pare-toi...";
    consigneEl.classList.remove("is-pulse");
    currentAction = null;

    const cfg = DIFFICULTIES[difficulty] || DIFFICULTIES.normal;
    refreshDifficulty();
    let delay = Math.random() * (cfg.delayMax - cfg.delayMin) + cfg.delayMin;
    roundDelayTimeout = setTimeout(()=>{
        currentAction = consignes[Math.floor(Math.random()*consignes.length)];
        consigneEl.textContent = currentAction.toUpperCase();
        consigneEl.classList.add("is-pulse");
        promptAt = nowMs();
        setReady(true);
        startTimer();
    }, delay);
}

function startTimer(){
    timerFill.style.width = "100%";
    const startAt = nowMs();
    function tick(){
        if (!ready) return;
        const t = nowMs();
        const elapsed = Math.max(0, t - startAt);
        const pct = Math.max(0, 100 - (elapsed / roundDurationMs) * 100);
        timerFill.style.width = pct.toFixed(2) + "%";
        if (elapsed >= roundDurationMs) {
            endGame();
            return;
        }
        timerRaf = requestAnimationFrame(tick);
    }
    timerRaf = requestAnimationFrame(tick);
}

function attempt(action){
    if(!ready) return;
    if (currentAction === action){
        success();
        return;
    }

    // Tol√©rance : si on attend un double-clic, un clic simple ne fait pas perdre.
    if (currentAction === "double-clic" && action === "clic gauche"){
        return;
    }
    endGame();
}

clickArea.addEventListener("mouseup", e => {
    if(!ready) return;
    if(e.button !== 0) return;
    attempt("clic gauche");
});

clickArea.addEventListener("dblclick", () => {
    if(!ready) return;
    attempt("double-clic");
});

clickArea.addEventListener("contextmenu", e => {
    e.preventDefault();
    if(!ready) return;
    attempt("clic droit");
});

clickArea.addEventListener("pointerdown", e => {
    if (!ready) return;
    if (e.pointerType !== "touch" && e.pointerType !== "pen") return;
    longPressFired = false;
    clearTimeout(longPressTimeout);
    longPressTimeout = setTimeout(() => {
        longPressFired = true;
        attempt("clic droit");
    }, LONG_PRESS_MS);
}, { passive: true });

clickArea.addEventListener("pointerup", e => {
    if (e.pointerType !== "touch" && e.pointerType !== "pen") return;
    clearTimeout(longPressTimeout);
    longPressTimeout = null;
    if (longPressFired) return;
    if (!ready) return;

    if (currentAction === "double-clic") {
        const now = nowMs();
        if (awaitingDoubleTap && (now - lastTapAt) <= DOUBLE_TAP_MS) {
            awaitingDoubleTap = false;
            clearTimeout(resetDoubleTapTimeout);
            resetDoubleTapTimeout = null;
            attempt("double-clic");
            return;
        }
        awaitingDoubleTap = true;
        lastTapAt = now;
        clearTimeout(resetDoubleTapTimeout);
        resetDoubleTapTimeout = setTimeout(() => {
            awaitingDoubleTap = false;
        }, DOUBLE_TAP_MS);
        return;
    }

    attempt("clic gauche");
}, { passive: true });

document.addEventListener("keydown", e => {
    if (!ready) return;
    if (isTypingTarget(e.target)) return;
    if (e.ctrlKey || e.metaKey || e.altKey) return;
    const key = String(e.key || "");
    if (key === " " || key === "Enter") {
        e.preventDefault();
        attempt("clic gauche");
    } else if (key === "r" || key === "R") {
        attempt("clic droit");
    } else if (key === "d" || key === "D") {
        attempt("double-clic");
    }
});

function success(){
    stopRoundTimers();
    setReady(false);
    clickArea.classList.remove("bad");
    clickArea.classList.add("ok");
    vibrate(25);
    if (ui) ui.playTone("ok");

    // R√©action
    reactionLastMs = Math.max(0, Math.round(nowMs() - promptAt));
    reactionSumMs += reactionLastMs;
    reactionCount += 1;
    reactionBestMs = Math.min(reactionBestMs, reactionLastMs);
    reactionEl.textContent = reactionLastMs + " ms";

    score++;
    scoreEl.textContent = String(score);
    level = 1 + Math.floor(score / 10);
    levelEl.textContent = String(level);

    if(score > best){
        best = score;
        localStorage.setItem("bestClickScore", String(best));
        bestEl.textContent = String(best);
        uiToast("Nouveau record !", "ok");
        uiOk();
    } else if (score % 10 === 0) {
        uiToast("Niveau " + level + " !", "info");
        if (ui) ui.playTone("level");
    }

    setTimeout(() => {
        clearFeedback();
        nextRound();
    }, 140);
}

function endGame(){
    stopRoundTimers();
    setReady(false);
    clickArea.classList.remove("ok");
    clickArea.classList.add("bad");
    vibrate([60, 30, 60]);
    uiBad();
    showScreen("game-over");
    document.getElementById("final-score").textContent = "Score : " + score;
    const avg = reactionCount ? Math.round(reactionSumMs / reactionCount) : 0;
    const bestReactTxt = Number.isFinite(reactionBestMs) ? (reactionBestMs + " ms") : "‚Äî";
    finalDetailsEl.textContent = "R√©action moyenne : " + (avg ? (avg + " ms") : "‚Äî") + " ¬∑ Meilleure : " + bestReactTxt;

    if (window.proactifMarkExerciseDone) {
        try { window.proactifMarkExerciseDone(); } catch (e) { }
    }
}

if (hintEl) {
    if (isTouchDevice()) {
        hintEl.innerHTML = "Sur mobile : <span class=\"kbd\">tap</span> = clic gauche, <span class=\"kbd\">appui long</span> = clic droit, <span class=\"kbd\">double tap</span> = double-clic.";
    } else {
        hintEl.innerHTML = "Clavier : <span class=\"kbd\">Espace</span> = clic gauche, <span class=\"kbd\">R</span> = clic droit, <span class=\"kbd\">D</span> = double-clic.";
    }
}

// UI prefs
try {
    const savedDiff = localStorage.getItem(DIFF_KEY);
    if (savedDiff && DIFFICULTIES[savedDiff]) difficulty = savedDiff;
} catch (e) {}
if (difficultyEl) {
    difficultyEl.value = difficulty;
    difficultyEl.addEventListener("change", () => {
        setDifficulty(difficultyEl.value);
        uiToast("Difficult√© : " + (DIFFICULTIES[difficulty].label || difficulty), "info");
    });
}
if (ui && soundToggle) ui.bindSoundToggle(soundToggle);
</script>
  </main>
</div>

</body>
</html>
